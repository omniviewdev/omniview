syntax = "proto3";
package com.omniview.pluginsdk;

import "google/protobuf/struct.proto";
import "proto/resource_common.proto";

option go_package = "./proto";

message HasInformerRequest {
  string connection = 1;
}

message StartConnectionInformerRequest {
  string key = 1;
  string connection = 2;
}

message StopConnectionInformerRequest {
  string key = 1;
  string connection = 2;
}

// Informer sync policy controls when an informer starts.
enum InformerSyncPolicy {
  SYNC_ON_CONNECT = 0;
  SYNC_ON_FIRST_QUERY = 1;
  SYNC_NEVER = 2;
}

// Informer resource state represents the sync state of a single resource type's informer.
enum InformerResourceState {
  INFORMER_PENDING = 0;
  INFORMER_SYNCING = 1;
  INFORMER_SYNCED = 2;
  INFORMER_ERROR = 3;
  INFORMER_CANCELLED = 4;
}

// InformerStateEvent is emitted when a resource's informer state changes.
message InformerStateEvent {
  string connection = 1;
  string resource_key = 2;
  InformerResourceState state = 3;
  int32 resource_count = 4;
  int32 total_count = 5;        // -1 if unknown
  ResourceError error = 6;      // from resource_common.proto
}

// InformerConnectionSummary provides an aggregate view of all informer states for a connection.
message InformerConnectionSummary {
  string connection = 1;
  map<string, InformerResourceState> resources = 2;
  map<string, int32> resource_counts = 3;
  int32 total_resources = 4;
  int32 synced_count = 5;
  int32 error_count = 6;
}

message GetInformerStateRequest {
  string connection = 1;
}

message EnsureInformerRequest {
  string connection = 1;
  string resource_key = 2;
}

message InformerEvent {
  string key = 1;
  string connection = 2;
  string id = 3;
  string namespace = 4;
  oneof action {
    InformerAddEvent add = 5;
    InformerUpdateEvent update = 6;
    InformerDeleteEvent delete = 7;
    InformerStateEvent state = 8;
  }
}

message InformerAddEvent {
  google.protobuf.Struct data = 1;
}

message InformerUpdateEvent {
  google.protobuf.Struct old_data = 1;
  google.protobuf.Struct new_data = 2;
}

message InformerDeleteEvent {
  google.protobuf.Struct data = 1;
}
