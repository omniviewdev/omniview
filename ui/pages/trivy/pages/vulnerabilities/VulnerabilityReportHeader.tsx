import React from 'react';
import { type TrivyReport } from '../../parser';
import Box from '@mui/material/Box';
import Grid from '@mui/material/Grid';
import { Stack } from '@omniviewdev/ui/layout';
import { Text } from '@omniviewdev/ui/typography';
import { Chip, List, ListItem, ListDivider } from '@omniviewdev/ui';
import { PieChart, pieArcLabelClasses } from '@mui/x-charts/PieChart';
import Icon from '@/components/icons/Icon';
import { formatDistance } from 'date-fns';
import { darken } from '@mui/material';

type Props = {
  report: TrivyReport;
};

const ReportInfoHeader: React.FC<Props> = ({ report }) => {
  const sections = [
    { label: 'Type', value: <ArtifactIcon artifactType={report.getArtifactType()} /> },
    { label: 'Name', value: <Text weight='semibold' size='sm'>{report.getArtifactName()}</Text> },
    { label: 'Created At', value: <Text weight='semibold' size='sm'>{formatDistance(new Date(report.getCreatedAt()), new Date(), { addSuffix: true } )}</Text> },
  ];

  return (
    <Grid container>
      <Grid size={{ xs: 12, lg: 7, xl: 8 }} sx={{ pr: 1 }}>
        <Box sx={{ borderRadius: 1, border: '1px solid', borderColor: 'divider' }}>
          <List size='sm'>
            {sections.map((display, index, arr) => (
              <>
                <ListItem key={index}>
                  <Box
                    sx={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      width: '100%',
                    }}
                  >
                    <Text weight='semibold' size='sm' component="div">
                      {display.label}
                    </Text>
                    {display.value}
                  </Box>
                </ListItem>
                {index < arr?.length - 1 && <ListDivider />}
              </>
            ))}
          </List>
        </Box>
      </Grid>
      <Grid size={{ xs: 12, lg: 5, xl: 4 }}>
        <Box sx={{ borderRadius: 1, border: '1px solid', borderColor: 'divider', p: 1 }}>
          <ReportVulnerabilityChart report={report} />
        </Box>
      </Grid>
    </Grid>
  );
};

const ReportVulnerabilityChart: React.FC<{ report: TrivyReport }> = ({ report }) => {
  const breakdown = report.getVulnerabilityBreakdown();

  const colorMap: Record<string, string> = {
    'CRITICAL': darken('#FF0000', 0.3),
    'HIGH': darken('#FFA500', 0.3),
    'MEDIUM': darken('#FFD700', 0.3),
    'LOW': darken('#32CD32', 0.3),
    'UNKNOWN': darken('#808080', 0.3),
  };

  const labelMap: Record<string, string> = {
    'CRITICAL': 'Critical',
    'HIGH': 'High',
    'MEDIUM': 'Medium',
    'LOW': 'Low',
    'UNKNOWN': 'Unknown',
  };

  return (
    <PieChart
      series={[
        {
          data: Object.entries(breakdown).map(([key, value]) => ({
            id: key,
            color: colorMap[key],
            value: value.count,
            label: labelMap[key],
          })),
          // arcLabel: (item) => `${breakdown[item.id].percentage}%`,
          innerRadius: 25,
          outerRadius: 50,
          paddingAngle: 5,
          cornerRadius: 5,
          highlightScope: { faded: 'global', highlighted: 'item' },
          faded: { innerRadius: 30, additionalRadius: -30, color: 'gray' },
        },
      ]}
      sx={{
        [`& .${pieArcLabelClasses.root}`]: {
          fill: 'white',
          fontSize: 14,
        },
      }}
      height={106}
    />
  );
};

const ArtifactIcon: React.FC<{ artifactType: string }> = ({ artifactType }) => {
  let icon = 'LuFile';
  let label = 'Unknown';

  switch (artifactType) {
    case 'container_image':
      icon = 'LuContainer';
      label = 'Container Image';
      break;
    case 'fs_layer':
      icon = 'LuFile';
      label = 'Filesystem';
      break;
    default:
      icon = 'LuFile';
      label = 'Unknown';
      break;
  }

  return (
    <Chip icon={
      <Icon name={icon} size={16} />
    } size='md' color='primary' label={label} />
  );
};

export default ReportInfoHeader;
