
import Box from '@mui/material/Box';
import LinearProgress from '@mui/material/LinearProgress';
import { Stack } from '@omniviewdev/ui/layout';
import { Text, Link } from '@omniviewdev/ui/typography';
import { Chip, List, ListItem, ListDivider } from '@omniviewdev/ui';

import { getSeverityColor } from './utils';
import { type TrivyVulnerability } from '../../types';
import { BrowserOpenURL } from '@omniviewdev/runtime/runtime';

export const VulnerabilityInfoList: React.FC<{ item: TrivyVulnerability }> = ({ item }) => {
  const displays: Array<{ label: string; value: string | React.ReactNode; isLink?: boolean }> = [
    {
      label: 'CVSS Score', value: (
        <Stack
          display={'flex'}
          direction='row'
          justifyContent='flex-end'
          alignItems='center'
          textAlign='center'
          gap={1}
          sx={{
            minWidth: 300,
          }}
        >
          {item?.CVSS?.nvd?.V3Score && <LinearProgress
            variant='determinate'
            value={item?.CVSS?.nvd?.V3Score * 10}
            sx={{ maxWidth: 300, flex: 1 }}
            color={getSeverityColor(item.Severity) === 'danger' ? 'error' : getSeverityColor(item.Severity) === 'neutral' ? 'inherit' : getSeverityColor(item.Severity) as 'primary' | 'warning'}
          />}
          <Chip
            sx={{
              mr: -1,
              borderRadius: 1,
            }}
            color={getSeverityColor(item.Severity)}
            label={item?.CVSS?.nvd?.V3Score?.toString() ?? 'N/A'}
          />
        </Stack>
      )
    },
    { label: 'Package', value: item.PkgName },
    { label: 'Status', value: item.Status },
    { label: 'Installed Version', value: item.InstalledVersion },
    { label: 'Fixed Version', value: item.FixedVersion },
    { label: 'More Info', value: item.PrimaryURL, isLink: true },
  ];

  return (

    <Box sx={{ borderRadius: 1, border: '1px solid', borderColor: 'divider' }}>
      <List
        size='sm'
      >
        {displays.map((display, index) => (
          <>
            <ListItem key={index}>
              <Box
                sx={{
                  px: 0.5,
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  width: '100%',
                }}
              >
                <Text size='sm' component="div">
                  {display.label}
                </Text>
                {typeof display.value === 'string' ? (
                  <Text size='sm' sx={{ fontWeight: 600 }} component="div">
                    {display.isLink ? (
                      <Link
                        component='button'
                        onClick={() => {
                          BrowserOpenURL(display.value as string);
                        }}
                        sx={{ fontWeight: 'bold' }}
                      >
                        {display.value}
                      </Link>
                    ) : (
                      display.value
                    )}
                  </Text>
                ) : display.value}
              </Box>
            </ListItem>
            {index < displays.length - 1 && <ListDivider />}
          </>
        ))}
      </List>
    </Box>
  );
};
