import React from 'react';

import Box from '@mui/material/Box';
import Grid from '@mui/material/Grid';
import Divider from '@mui/material/Divider';
import { Text, Link } from '@omniviewdev/ui/typography';
import { Heading } from '@omniviewdev/ui/typography';
import { List, ListItem, ListDivider } from '@omniviewdev/ui';

import { BrowserOpenURL } from '@omniviewdev/runtime/runtime';

import {
  type Row as RowT,
  flexRender,
} from '@tanstack/react-table';
import { type TrivyVulnerability } from '../../types';
import { VulnerabilityInfoList } from './VulnerabilityInfoList';
import VulnerabilityVectorsList from './VulnerabilityVectorsList';

export default function Row(props: { row: RowT<TrivyVulnerability> }) {
  const { row } = props;

  return (
    <React.Fragment>
      <tr
        key={row.id}
        style={{
          cursor: 'pointer',
          WebkitUserSelect: 'text',
          display: 'flex',
          width: '100%',
        }}
      >
        {row.getVisibleCells().map(cell => (
          <td
            key={cell.id}
            onClick={() => {
              row.toggleExpanded();
            }}
            style={{
              width: cell.column.getSize() === Number.MAX_SAFE_INTEGER ? 'auto' : cell.column.getSize(),
              maxWidth: cell.column.getSize() === Number.MAX_SAFE_INTEGER ? 'auto' : cell.column.getSize(),
              display: 'flex',
              flex: 1,
              textOverflow: 'ellipsis',
              overflow: 'hidden',
              // always have text vertically centered
              alignItems: 'center',
            }}
          >
            {flexRender(cell.column.columnDef.cell, cell.getContext())}
          </td>
        ))}
      </tr>
      <tr>
        <td style={{ height: 0, padding: 0 }}>
          {row.getIsExpanded() && (
            <Grid
              container
              sx={{
                p: 2,
                pl: 6,
                display: 'flex',
                alignItems: 'stretch',
                boxShadow: 'inset 0 3px 6px 0 rgba(0 0 0 / 0.08)',
                bgcolor: 'action.hover',
              }}
            >
              <Grid
                size={{ xl: 7, xs: 12 }}
                sx={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: 1,
                  paddingRight: 2,
                }}
              >
                <Heading level={4}>
                  {row.original.VulnerabilityID}
                </Heading>
                <Text weight='semibold' component="div">
                  {row.original.Title}
                </Text>
                <Text size='sm' component="div">
                  {row.original.Description}
                </Text>
                <Box
                  sx={{
                    borderRadius: 1,
                    mt: 1,
                    display: 'flex',
                    flexDirection: 'column',
                    border: '1px solid',
                    borderColor: 'divider',
                  }}
                >
                  <Text sx={{ p: 1, fontWeight: 700 }} weight='semibold' size='sm' component="div">
                    References
                  </Text>
                  <Divider />
                  <List
                    size='sm'
                    sx={{
                      p: 0,
                      maxHeight: 462,
                      overflow: 'auto',
                      overscrollBehavior: 'contain',
                    }}
                  >
                    {row.original.References.map((display, index) => (
                      <>
                        <ListItem key={display}>
                          <Box
                            sx={{
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center',
                              width: '100%',
                            }}
                          >
                            <Text size='sm' sx={{ fontWeight: 600 }} component="div">
                              <Link
                                component='button'
                                onClick={() => {
                                  BrowserOpenURL(display);
                                }}
                                sx={{ fontWeight: 'bold' }}
                              >
                                {display}
                              </Link>
                            </Text>
                          </Box>
                        </ListItem>
                        {index < row.original.References?.length - 1 && <ListDivider sx={{ m: 0 }} />}
                      </>
                    ))}
                  </List>
                </Box>
              </Grid>
              <Grid
                size={{ xl: 5, xs: 12 }}
                sx={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: 1,
                }}
              >
                <VulnerabilityInfoList item={row.original} />
                {row.original?.CVSS?.nvd?.V3Vector && <VulnerabilityVectorsList vector={row.original.CVSS.nvd.V3Vector} />}
              </Grid>
            </Grid>
          )}
        </td>
      </tr>
    </React.Fragment>
  );
}
