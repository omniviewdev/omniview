package registry

import (
	"crypto/ed25519"
	"encoding/base64"
	"encoding/hex"
	"errors"
	"fmt"

	"github.com/omniviewdev/omniview/backend/pkg/apperror"
)

// OmniviewPublicKeyHex is the hex-encoded Ed25519 public key used to verify plugin signatures.
// Replace this placeholder with the real key generated by `registry-cli keygen`.
var OmniviewPublicKeyHex = "c84100654c6c0d42e8a86f16253a21b7f01b8e914d83ba07ce072f086a8add31"

var omniviewPublicKey ed25519.PublicKey

var (
	ErrUnsignedArtifact = errors.New("artifact is not signed")
	ErrInvalidSignature = errors.New("invalid artifact signature")
)

func init() {
	key, err := hex.DecodeString(OmniviewPublicKeyHex)
	if err != nil {
		panic(fmt.Sprintf("failed to decode embedded public key: %v", err))
	}
	omniviewPublicKey = ed25519.PublicKey(key)
}

// VerifyArtifactSignature verifies that the given checksum was signed by the Omniview signing key.
func VerifyArtifactSignature(checksum, signatureB64 string) error {
	if signatureB64 == "" {
		return ErrUnsignedArtifact
	}

	sig, err := base64.StdEncoding.DecodeString(signatureB64)
	if err != nil {
		return apperror.WrapWithDetail(err, apperror.TypeValidation, 422, "Invalid signature", fmt.Sprintf("Malformed base64 signature: %s", err.Error()))
	}

	if !ed25519.Verify(omniviewPublicKey, []byte(checksum), sig) {
		return ErrInvalidSignature
	}

	return nil
}
